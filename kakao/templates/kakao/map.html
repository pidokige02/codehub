{% extends "base.html" %}
{% load static %}  <!-- âœ… static íƒœê·¸ ë°˜ë“œì‹œ ì¶”ê°€ -->

{% block extra_head %}
  <!-- âœ… CSS íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° -->
  <link rel="stylesheet" href="{% static 'css/map.css' %}">
  <script src="https://kit.fontawesome.com/a2e0e6d6e1.js" crossorigin="anonymous"></script>

{% endblock %}

{% block content %}
  <div class="kakao-map-container">
    <!-- ì™¼ìª½ íŒ¨ë„ -->
    <div class="kakao-map-sidebar">
      <div class="kakao-map-header">
        <h1>kakao<span style="font-weight:700;">map</span></h1>
        <label><input type="radio" checked> í˜„ ì§€ë„ ë‚´ ì¥ì†Œê²€ìƒ‰</label>
      </div>

      <div class="kakao-map-search">
        <input id="keyword" type="text" placeholder="ì¥ì†Œ, ì£¼ì†Œ, ë²„ìŠ¤ ê²€ìƒ‰">
        <button id="search">ê²€ìƒ‰</button>
      </div>

      <!-- íƒ­ ë©”ë‰´ -->
      <div class="kakao-map-tabs">
        <div class="kakao-map-tab active" data-tab="search">ê²€ìƒ‰</div>
        <div class="kakao-map-tab" data-tab="route">ê¸¸ì°¾ê¸°</div>
        <div class="kakao-map-tab" data-tab="bus">ë²„ìŠ¤</div>
        <div class="kakao-map-tab" data-tab="subway">ì§€í•˜ì² </div>
        <div class="kakao-map-tab" data-tab="my">MY</div>
      </div>

      <!-- íƒ­ ì½˜í…ì¸  -->
      <div class="kakao-map-tab-content" id="tab-search">
        ğŸ” ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”.
      </div>
      <div class="kakao-map-tab-content" id="tab-route" style="display:none;">
        ğŸš— ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
      </div>
      <div class="kakao-map-tab-content" id="tab-bus" style="display:none;">
        ğŸšŒ ë²„ìŠ¤ ë…¸ì„ ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
      <div class="kakao-map-tab-content" id="tab-subway" style="display:none;">
        ğŸš‡ ì§€í•˜ì²  ë…¸ì„ ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”.
      </div>
      <div class="kakao-map-tab-content" id="tab-my" style="display:none;">
        â­ ì¦ê²¨ì°¾ê¸° ì¥ì†Œë¥¼ ì €ì¥í•˜ì„¸ìš”.
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì§€ë„ -->
    <div class="kakao-map-area" id="map"></div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&libraries=services&autoload=false"></script>

  <script>
    // SDK ë¡œë“œê°€ ì™„ë£Œëœ í›„ì— ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥
    kakao.maps.load(function() {
      const mapContainer = document.getElementById('map');
      const mapOption = {
        center: new kakao.maps.LatLng(37.504398, 127.011081),
        level: 4
      };
      const map = new kakao.maps.Map(mapContainer, mapOption);
      const ps = new kakao.maps.services.Places();
      const infowindow = new kakao.maps.InfoWindow({zIndex:1});

      $("#search").click(function() {
        const keyword = $("#keyword").val();
        if (!keyword.trim()) {
          $("#resultList").html("<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>");
          return;
        }
        ps.keywordSearch(keyword, placesSearchCB);
      });

      function placesSearchCB(data, status) {
        const listEl = $("#resultList");
        listEl.empty();

        if (status === kakao.maps.services.Status.OK) {
          const bounds = new kakao.maps.LatLngBounds();
          data.forEach(function(place) {
            const item = $(`<div style="padding:8px; border-bottom:1px solid #ddd; cursor:pointer;">
                              <strong>${place.place_name}</strong><br>
                              <small>${place.address_name}</small>
                            </div>`);
            item.on("click", function() {
              const pos = new kakao.maps.LatLng(place.y, place.x);
              map.setCenter(pos);
              infowindow.setContent(`<div style="padding:5px;">${place.place_name}</div>`);
              infowindow.open(map, new kakao.maps.Marker({position: pos}));
            });
            listEl.append(item);
            bounds.extend(new kakao.maps.LatLng(place.y, place.x));
          });
          map.setBounds(bounds);
        } else {
          listEl.html("<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>");
        }
      }
      // íƒ­ ì „í™˜
      $(".kakao-map-tab").click(function() {
        $(".kakao-map-tab").removeClass("active");
        $(this).addClass("active");

        $(".kakao-map-tab-content").hide();
        const target = $(this).data("tab");
        $("#tab-" + target).show();
      });
    });
  </script>
{% endblock %}
